<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Android,smali,逆向,安全,">





  <link rel="alternate" href="/atom.xml" title="Wossoneri`s Blog" type="application/atom+xml">






<meta name="description" content="简单介绍Android逆向的一些思路">
<meta name="keywords" content="Android,smali,逆向,安全">
<meta property="og:type" content="article">
<meta property="og:title" content="[Android][Security] Android 逆向之 smali">
<meta property="og:url" content="http://wossoneri.github.io/2019/09/12/[Android][Security]Decompile-smali/index.html">
<meta property="og:site_name" content="Wossoneri`s Blog">
<meta property="og:description" content="简单介绍Android逆向的一些思路">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-12-18T08:46:36.599Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[Android][Security] Android 逆向之 smali">
<meta name="twitter:description" content="简单介绍Android逆向的一些思路">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '6234852363740382000',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://wossoneri.github.io/2019/09/12/[Android][Security]Decompile-smali/">





  <title>[Android][Security] Android 逆向之 smali | Wossoneri`s Blog</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-70716047-2', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0af9c6850b24b42a4713ad1c9c691675";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
    <a href="https://github.com"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/121cd7cbdc3e4855075ea8b558508b91ac463ac2/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_green_007200.png"></a>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Wossoneri`s Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">业 精于勤而荒于嬉，行 成于思而毁于随</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://wossoneri.github.io/2019/09/12/[Android][Security]Decompile-smali/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wossoneri">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/11764431?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wossoneri`s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">[Android][Security] Android 逆向之 smali</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-12T23:00:00+08:00">
                2019-09-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/09/12/[Android][Security]Decompile-smali/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count gitment-comments-count" data-xid="/2019/09/12/[Android][Security]Decompile-smali/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          
          
	
  		  <span class="post-letters-count">
            &nbsp; | &nbsp;
            <span class="post-meta-item-icon">
                 <i class="fa fa-clock-o"></i>
            </span>
		        <span class="post-meta-item-text">总记</span>
            <span class="post-count">5,062 字</span>
		        <span class="post-meta-item-text">读完需要</span>
    		    <span class="post-count">21 分</span>
  		  </span>
           
         

          

          

          
              <div class="post-description">
                  简单介绍Android逆向的一些思路
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="几个概念"><a href="#几个概念" class="headerlink" title="几个概念"></a>几个概念</h2><h3 id="APK"><a href="#APK" class="headerlink" title="APK"></a>APK</h3><p>APK其实就是一个ZIP压缩包，将APK后缀改成ZIP后就可以解压出APK内部文件。</p>
<h3 id="Dalvik字节码"><a href="#Dalvik字节码" class="headerlink" title="Dalvik字节码"></a>Dalvik字节码</h3><p>Dalvik是google专门为Android操作系统设计的一个虚拟机，经过深度的优化。虽然Android上的程序是使用java来开发的，但是Dalvik和标准的java虚拟机JVM还是两回事。Dalvik VM是基于寄存器的，而JVM是基于栈的；Dalvik有专属的文件执行格式dex（dalvik executable），而JVM则执行的是java字节码。Dalvik VM比JVM速度更快，占用空间更少。</p>
<h2 id="如何逆向"><a href="#如何逆向" class="headerlink" title="如何逆向"></a>如何逆向</h2><h3 id="查看资源文件"><a href="#查看资源文件" class="headerlink" title="查看资源文件"></a>查看资源文件</h3><ol>
<li><p>把要解压的APK拷贝到APKs目录</p>
</li>
<li><p>使用</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">apktool d APKs/xxx.apk -o dir</span><br></pre></td></tr></table></figure>
<p>将APK解压到当前目录，得到完整的资源文件。</p>
<blockquote>
<p>虽然通过解压的方式也可以得到资源文件目录，但是那样得到的xml文件并无法阅读。</p>
</blockquote>
</li>
<li><p>打包回APK</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">apktool b APKs/xxx –o file.apk</span><br></pre></td></tr></table></figure>
<p>将文件恢复到apk</p>
</li>
<li><p>重新签名</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">jarsigner -verbose -keystore demo.keystore -storepass demopass -signedjar signed.apk XimalayaNew.apk demoAlias</span><br></pre></td></tr></table></figure>
</li>
<li><p>解出来的文件结构</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">AndroidManifest.xml kotlin              smali               unknown</span><br><span class="line">apktool.yml         lib                 smali_classes2</span><br><span class="line">assets              original            smali_classes3</span><br><span class="line">build               res                 smali_classes4</span><br></pre></td></tr></table></figure>
<p>这样解出来可以看到有4个smali文件夹，里面都是smali文件。关于smali是这次的主角，后面再详细说。</p>
</li>
</ol>
<h3 id="查看源码"><a href="#查看源码" class="headerlink" title="查看源码"></a>查看源码</h3><ol>
<li><p>若要查看源码，将xxx.apk命名为xxx.zip，使用unzip命令解压，得到dex文件，目录结构如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">AndroidManifest.xml classes2.dex        javax               publicsuffixes.gz</span><br><span class="line">META-INF            classes3.dex        kotlin              push_version</span><br><span class="line">assets              classes4.dex        lib                 res</span><br><span class="line">classes.dex         com                 miui_push_version   resources.arsc</span><br></pre></td></tr></table></figure>
<p>这里也有xml文件，可以试着打开看看，发现这些文件打开是乱码。</p>
</li>
<li><p>使用<code>dex2jar</code>工具逆向dex文件：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">%</span><span class="bash"> d2j-dex2jar.sh *.dex</span></span><br><span class="line">dex2jar classes.dex -&gt; ./classes-dex2jar.jar</span><br><span class="line">Detail Error Information in File ./classes-error.zip</span><br><span class="line">Please report this file to http://code.google.com/p/dex2jar/issues/entry if possible.</span><br><span class="line">dex2jar classes2.dex -&gt; ./classes2-dex2jar.jar</span><br><span class="line">dex2jar classes3.dex -&gt; ./classes3-dex2jar.jar</span><br><span class="line">dex2jar classes4.dex -&gt; ./classes4-dex2jar.jar</span><br></pre></td></tr></table></figure>
<p>看到每个dex文件都生成了对应的jar文件。</p>
</li>
<li><p>用<code>JD-gui</code>工具打开这些<code>jar</code>文件，可以看到对应的源码。</p>
</li>
</ol>
<h3 id="分析思路"><a href="#分析思路" class="headerlink" title="分析思路"></a>分析思路</h3><p>代码可以通过<code>JD-GUI</code>查看，但是这个工具查代码并不方便，所以还是推荐把smali文件导入到编辑器中，在编辑器里查找要看的关键词，然后再回到<code>JD-GUI</code>查看源码。两者结合一起去看是效率最高的。</p>
<p><code>JD-GUI</code>看的代码有很多是混淆过的，但是一些系统回调方法是不能混淆的，比如<code>onCreate</code></p>
<ol>
<li>首先看这个类有没有静态方法和静态代码块，因为这类代码会在对象初始化前运行，可能在这里加载so文件，或者是加密校验等操作。</li>
<li>再看看这个类的构造方法。</li>
<li>最后看生命周期方法。</li>
</ol>
<h2 id="Smali"><a href="#Smali" class="headerlink" title="Smali"></a>Smali</h2><p>smali就是Dalvik VM内部执行的核心代码。它有自己的一套语法。</p>
<h3 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h3><div class="table-container">
<table>
<thead>
<tr>
<th>指令</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>.field private isFlag:z</td>
<td>定义变量</td>
</tr>
<tr>
<td>.method</td>
<td>方法</td>
</tr>
<tr>
<td>.parameter</td>
<td>方法参数</td>
</tr>
<tr>
<td>.prologue</td>
<td>方法开始</td>
</tr>
<tr>
<td>.line 12</td>
<td>此方法位于12行</td>
</tr>
<tr>
<td>invoke-super</td>
<td>调用父类方法</td>
</tr>
<tr>
<td>const/high16 v0,0x7fo3</td>
<td>把0x7fo3赋值给v0</td>
</tr>
<tr>
<td>invoke-direct</td>
<td>调用函数</td>
</tr>
<tr>
<td>return-void</td>
<td>函数返回void</td>
</tr>
<tr>
<td>.end method</td>
<td>函数结束</td>
</tr>
<tr>
<td>new-instance</td>
<td>创建实例</td>
</tr>
<tr>
<td>input-object</td>
<td>对象赋值</td>
</tr>
<tr>
<td>iget-object</td>
<td>调用对象</td>
</tr>
<tr>
<td>Invoke-static</td>
<td>调用静态函数</td>
</tr>
</tbody>
</table>
</div>
<h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><div class="table-container">
<table>
<thead>
<tr>
<th>符号</th>
<th>类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>B</td>
<td>byte</td>
</tr>
<tr>
<td>C</td>
<td>char</td>
</tr>
<tr>
<td>D</td>
<td>double</td>
</tr>
<tr>
<td>F</td>
<td>float</td>
</tr>
<tr>
<td>I</td>
<td>int</td>
</tr>
<tr>
<td>J</td>
<td>long</td>
</tr>
<tr>
<td>S</td>
<td>short</td>
</tr>
<tr>
<td>V</td>
<td>void</td>
</tr>
<tr>
<td>Z</td>
<td>boolean</td>
</tr>
<tr>
<td>[XXX</td>
<td>Array</td>
</tr>
<tr>
<td>Lxxx/yyy</td>
<td>Object</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>数组：</p>
<p>在基本类型前加上前中括号“[”，例如int数组和float数组分别表示为：[I、[F</p>
<p>对象：</p>
<p>以L作为开头，格式是LpackageName/objectName<strong>;</strong></p>
<p>String对象在smali中为：Ljava/lang/String;</p>
<p>类里面的内部类：LpackageName/objectName$subObjectName;</p>
</blockquote>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><p>函数公式为：</p>
<p><code>Func-Name (Para-Type1Para-Type2Para-Type3...)Return-Type</code></p>
<p>参数之间没有间隔。</p>
<p>举例：</p>
<ul>
<li><p>foo ()V</p>
<p>void foo()</p>
</li>
<li><p>foo (III)Z</p>
<p>boolean foo(int, int, int)</p>
</li>
<li><p>foo (Z[I[ILjava/lang/String;J)Ljava/lang/String;</p>
<p>String foo(boolean, int[], int[], String, long)</p>
</li>
</ul>
<h3 id="文件分析"><a href="#文件分析" class="headerlink" title="文件分析"></a>文件分析</h3><figure class="highlight smali"><table><tr><td class="code"><pre><span class="line"><span class="keyword">.class</span><span class="keyword"> public</span> <span class="class">Lcom/disney/WMW/WMWActivity;</span> </span><br><span class="line"><span class="keyword">.super</span> <span class="class">Lcom/disney/common/BaseActivity;</span></span><br><span class="line"><span class="keyword">.source</span> <span class="string">"WMWActivity.java"</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># interfaces</span></span><br><span class="line"><span class="keyword">.implements</span> <span class="class">Lcom/burstly/lib/ui/IBurstlyAdListener;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># annotations</span></span><br><span class="line"><span class="keyword">.annotation</span><span class="keyword"> system</span> <span class="class">Ldalvik/annotation/MemberClasses;</span></span><br><span class="line">    value = &#123;</span><br><span class="line">        <span class="class">Lcom/disney/WMW/WMWActivity$MessageHandler;</span>,</span><br><span class="line">        <span class="class">Lcom/disney/WMW/WMWActivity$FinishActivityArgs;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">.end annotation</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># static fields</span></span><br><span class="line"><span class="keyword">.field</span><span class="keyword"> private</span><span class="keyword"> static</span><span class="keyword"> final</span> PREFS_INSTALLATION_ID:<span class="class">Ljava/lang/String;</span> = <span class="string">"installationId"</span></span><br><span class="line">//...</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># instance fields</span></span><br><span class="line"><span class="keyword">.field</span><span class="keyword"> private</span> _activityPackageName:<span class="class">Ljava/lang/String;</span></span><br><span class="line">//...</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># direct methods</span></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> static</span><span class="keyword"> constructor</span> &lt;clinit&gt;()V</span><br><span class="line"><span class="keyword">    .locals</span> 3</span><br><span class="line"> </span><br><span class="line"><span class="keyword">    .prologue</span></span><br><span class="line">    //...</span><br><span class="line"> </span><br><span class="line">    return-void</span><br><span class="line"><span class="keyword">.end method</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span><span class="keyword"> constructor</span> &lt;init&gt;()V</span><br><span class="line"><span class="keyword">    .locals</span> 3</span><br><span class="line"> </span><br><span class="line"><span class="keyword">    .prologue</span></span><br><span class="line">    //...</span><br><span class="line"> </span><br><span class="line">    return-void</span><br><span class="line"><span class="keyword">.end method</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> static</span><span class="keyword"> synthetic</span> access$100(<span class="class">Lcom/disney/WMW/WMWActivity;</span>)V</span><br><span class="line"><span class="keyword">    .locals</span> 0</span><br><span class="line"><span class="keyword">    .parameter</span> <span class="string">"x0"</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">    .prologue</span></span><br><span class="line"><span class="keyword">    .line</span> 37</span><br><span class="line">   <span class="built_in"> invoke-direct </span>&#123;p0&#125;, <span class="class">Lcom/disney/WMW/WMWActivity;</span>-&gt;initIap()V</span><br><span class="line"> </span><br><span class="line">    return-void</span><br><span class="line"><span class="keyword">.end method</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> static</span><span class="keyword"> synthetic</span> access$200(<span class="class">Lcom/disney/WMW/WMWActivity;</span>)<span class="class">Lcom/disney/common/WMWView;</span></span><br><span class="line"><span class="keyword">    .locals</span> 1</span><br><span class="line"><span class="keyword">    .parameter</span> <span class="string">"x0"</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">    .prologue</span></span><br><span class="line"><span class="keyword">    .line</span> 37</span><br><span class="line">   <span class="built_in"> iget-object </span>v0, p0, <span class="class">Lcom/disney/WMW/WMWActivity;</span>-&gt;_view:<span class="class">Lcom/disney/common/WMWView;</span></span><br><span class="line"> </span><br><span class="line">   <span class="built_in"> return-object </span>v0</span><br><span class="line"><span class="keyword">.end method</span></span><br><span class="line"> </span><br><span class="line">//...</span><br><span class="line"> </span><br><span class="line"><span class="comment">#virtual methods</span></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span> captureScreen()V</span><br><span class="line"><span class="keyword">    .locals</span> 4</span><br><span class="line"> </span><br><span class="line"><span class="keyword">    .prologue</span></span><br><span class="line">    //...</span><br><span class="line"> </span><br><span class="line">   <span class="built_in"> goto </span>:goto_0</span><br><span class="line"><span class="keyword">.end method</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span> didScreenCaptured()V</span><br><span class="line"><span class="keyword">    .locals</span> 6</span><br><span class="line"> </span><br><span class="line"><span class="keyword">    .prologue</span></span><br><span class="line">    //...</span><br><span class="line"> </span><br><span class="line">   <span class="built_in"> goto </span>:goto_0</span><br><span class="line"><span class="keyword">.end method</span></span><br></pre></td></tr></table></figure>
<h4 id="smali寄存器"><a href="#smali寄存器" class="headerlink" title="smali寄存器"></a>smali寄存器</h4><p>Dalvik VM与JVM的最大的区别之一就是Dalvik VM是基于寄存器的。基于寄存器是什么意思呢？也就是说，在smali里的所有操作都必须经过寄存器来进行：</p>
<p>本地寄存器用v开头数字结尾的符号来表示，如v0、v1、v2、…</p>
<p>参数寄存器则使用p开头数字结尾的符号来表示，如p0、p1、p2、…</p>
<p>特别注意的是，p0不一定是函数中的第一个参数：</p>
<p>在非static函数中，p0代指“this”，p1表示函数的第一个参数，p2代表函数中的第二个参数…</p>
<p>在static函数中p0才对应第一个参数（因为Java的static方法中没有this方法）。</p>
<p>本地寄存器没有限制，理论上是可以任意使用的，下面是例子： </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span>/<span class="number">4</span> v0, <span class="number">0x0</span></span><br><span class="line">iput-<span class="keyword">boolean</span> v0, p0, Lcom/disney/WMW/WMWActivity;-&gt;isRunning:Z</span><br></pre></td></tr></table></figure>
<p>在上面的两句中，使用了v0本地寄存器，并把值0x0存到v0中，然后第二句用iput-boolean这个指令把v0中的值存放到com.disney.WMW.WMWActivity.isRunning这个成员变量中。</p>
<p>即相当于：this.isRunning = false;（上面说过，在非static函数中p0代表的是“this”，在这里就是com.disney.WMW.WMWActivity实例）。</p>
<h4 id="smali中的继承、接口、包信息"><a href="#smali中的继承、接口、包信息" class="headerlink" title="smali中的继承、接口、包信息"></a>smali中的继承、接口、包信息</h4><figure class="highlight smali"><table><tr><td class="code"><pre><span class="line"><span class="keyword">.class</span><span class="keyword"> public</span> <span class="class">Lcom/disney/WMW/WMWActivity;</span> </span><br><span class="line"><span class="keyword">.super</span> <span class="class">Lcom/disney/common/BaseActivity;</span></span><br><span class="line"><span class="keyword">.source</span> <span class="string">"WMWActivity.java"</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># interfaces</span></span><br><span class="line"><span class="keyword">.implements</span> <span class="class">Lcom/burstly/lib/ui/IBurstlyAdListener;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># annotations</span></span><br><span class="line"><span class="keyword">.annotation</span><span class="keyword"> system</span> <span class="class">Ldalvik/annotation/MemberClasses;</span></span><br><span class="line">    value = &#123;</span><br><span class="line">        <span class="class">Lcom/disney/WMW/WMWActivity$MessageHandler;</span>,</span><br><span class="line">        <span class="class">Lcom/disney/WMW/WMWActivity$FinishActivityArgs;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">.end annotation</span></span><br></pre></td></tr></table></figure>
<p>1-3行定义的是基本信息：这是一个由WMWActivity.java编译得到的smali文件（第3行），它是com.disney.WMW这个package下的一个类（第1行），继承自com.disney.common.BaseActivity（第2行）。</p>
<p>5-6行定义的是接口信息：这个WMWActivity实现了一个com.burstly.lib.ui这个package下（一个广告SDK）的IBurstyAdListener接口。</p>
<p>8-14行定义的则是内部类：它有两个成员内部类——MessageHandler和FinishActivityArgs，内部类将在后面小节中会有提及。</p>
<p>所以对应的Java代码大概是这样：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WMWActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> <span class="keyword">implements</span> <span class="title">IBurstlyAdListener</span></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MessageHandler</span> </span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">FinishActivityArgs</span></span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="smali中的成员变量"><a href="#smali中的成员变量" class="headerlink" title="smali中的成员变量"></a>smali中的成员变量</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"># static fields</span><br><span class="line">.field <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> PREFS_INSTALLATION_ID:Ljava/lang/String; = <span class="string">"installationId"</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"># instance fields</span><br><span class="line">.field <span class="keyword">private</span> _activityPackageName:Ljava/lang/String;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<p>上面定义的static fields和instance fields均为成员变量，格式是：</p>
<p><code>.field public/private [static] [final] varName:&lt;类型&gt;</code></p>
<p>然而static fields和instance fields还是有区别的，当然区别很明显，那就是static fields是static的，而instance则不是。</p>
<p>根据这个区别来获取这些不同的成员变量时也有不同的指令。</p>
<p>获取的指令有：iget、sget、iget-boolean、sget-boolean、iget-object、sget-object等，</p>
<p>操作的指令有：iput、sput、iput-boolean、sput-boolean、iput-object、sput-object等。</p>
<p>没有“-object”后缀的表示操作的成员变量对象是基本数据类型，带“-object”表示操作的成员变量是对象类型，特别地，boolean类型则使用带“-boolean”的指令操作。</p>
<h5 id="获取static-fields的指令类似是："><a href="#获取static-fields的指令类似是：" class="headerlink" title="获取static fields的指令类似是："></a>获取static fields的指令类似是：</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">sget-object v0, Lcom/disney/WMW/WMWActivity;-&gt;PREFS_INSTALLATION_ID:Ljava/lang/String;</span><br></pre></td></tr></table></figure>
<p>sget-object就是用来获取变量值并保存到紧接着的参数的寄存器中，在这里，把上面出现的<code>PREFS_INSTALLATION_ID</code>这个String成员变量获取并放到v0这个寄存器中，<strong>注意：前面需要该变量所属的类的类型，后面需要加一个冒号和该成员变量的类型</strong>，中间是“-&gt;”表示所属关系。</p>
<h5 id="获取instance-fields"><a href="#获取instance-fields" class="headerlink" title="获取instance fields"></a>获取instance fields</h5><p>指令与static fields的基本一样，只是由于不是static变量，不能仅仅指出该变量所在类的类型，还需要该变量所在类的实例。看例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">iget-object v0, p0, Lcom/disney/WMW/WMWActivity;-&gt;_view:Lcom/disney/common/WMWView;</span><br></pre></td></tr></table></figure>
<p>可以看到iget-object指令比sget-object多了一个参数，就是该变量所在类的实例，在这里就是p0即“this”。</p>
<h5 id="获取array的还有aget和aget-object"><a href="#获取array的还有aget和aget-object" class="headerlink" title="获取array的还有aget和aget-object"></a>获取array的还有aget和aget-object</h5><p>指令使用和上述类似，不细述。</p>
<h5 id="put指令的使用和get指令是统一的"><a href="#put指令的使用和get指令是统一的" class="headerlink" title="put指令的使用和get指令是统一的"></a>put指令的使用和get指令是统一的</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span>/<span class="number">4</span> v3, <span class="number">0x0</span></span><br><span class="line">sput-object v3, Lcom/disney/WMW/WMWActivity;-&gt;globalIapHandler:Lcom/disney/config/GlobalPurchaseHandler;</span><br></pre></td></tr></table></figure>
<p>相当于：this.globalIapHandler = null;（null = 0x0）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.local v0, wait:Landroid/os/Message;</span><br><span class="line"><span class="keyword">const</span>/<span class="number">4</span> v1, <span class="number">0x2</span></span><br><span class="line">iput v1, v0, Landroid/os/Message;-&gt;what:I</span><br></pre></td></tr></table></figure>
<p>相当于：wait.what = 0x2;（wait是Message的实例）</p>
<h4 id="smali中的函数调用"><a href="#smali中的函数调用" class="headerlink" title="smali中的函数调用"></a>smali中的函数调用</h4><p>smali中的函数和成员变量一样也分为两种类型，但是不同成员变量中的static和instance之分，而是direct和virtual之分。那么direct method和virtual method有什么区别呢？直白地讲，direct method就是private函数，其余的public和protected函数都属于virtual method。所以在调用函数时，有invoke-direct，invoke-virtual，另外还有invoke-static、invoke-super以及invoke-interface等几种不同的指令。当然其实还有invoke-XXX/range 指令的，这是参数多于4个的时候调用的指令，比较少见，了解下即可。</p>
<p><strong>invoke-static：</strong></p>
<p>顾名思义就是调用static函数的，因为是static函数，所以比起其他调用少一个参数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">invoke-<span class="keyword">static</span> &#123;&#125;, Lcom/disney/WMW/UnlockHelper;-&gt;unlockCrankypack()Z</span><br></pre></td></tr></table></figure>
<p>这里注意到invoke-static后面有一对大括号“{}”，其实是<strong>调用该方法的实例+参数列表</strong>，由于这个方法既不需参数也是static的，所以{}内为空，再看一个例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span>-string v0, <span class="string">"fmodex"</span></span><br><span class="line">invoke-<span class="keyword">static</span> &#123;v0&#125;, Ljava/lang/System;-&gt;loadLibrary(Ljava/lang/String;)V</span><br></pre></td></tr></table></figure>
<p>这个是调用static void System.loadLibrary(String)来加载NDK编译的so库用的方法，同样也是这里v0就是参数”fmodex”了。</p>
<p><strong>invoke-super：</strong></p>
<p>调用父类方法用的指令，在onCreate、onDestroy等方法都能看到，略。</p>
<p><strong>invoke-direct：</strong></p>
<p>调用private函数的，例如</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">invoke-direct &#123;p0&#125;, Lcom/disney/WMW/WMWActivity;-&gt;getGlobalIapHandler()Lcom/disney/config/GlobalPurchaseHandler;</span><br></pre></td></tr></table></figure>
<p>这里GlobalPurchaseHandler getGlobalIapHandler()就是定义在WMWActivity中的一个private函数，如果修改smali时错用invoke-virtual或invoke-static将在回编译后程序运行时引发一个常见的VerifyError</p>
<p><strong>invoke-virtual：</strong></p>
<p>用于调用protected或public函数，同样注意修改smali时不要错用invoke-direct或invoke-static，例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">sget-object v0, Lcom/disney/WMW/WMWActivity;-&gt;shareHandler:Landroid/os/Handler;</span><br><span class="line">invoke-virtual &#123;v0, v3&#125;, Landroid/os/Handler;-&gt;removeCallbacksAndMessages(Ljava/lang/Object;)V</span><br></pre></td></tr></table></figure>
<p>v0是shareHandler:Landroid/os/Handler，v3是传递给removeCallbackAndMessage方法的Ljava/lang/Object参数就可以了。</p>
<p><strong>invoke-xxxxx/range：</strong></p>
<p>当方法的参数多于5个时（含5个），不能直接使用以上的指令，而是在后面加上“/range”，使用方法也有所不同：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">invoke-<span class="keyword">static</span>/range &#123;v0 .. v5&#125;, Lcn/game189/sms/SMS;-&gt;checkFee(Ljava/lang/String;Landroid/app/Activity;Lcn/game189/sms/SMSListener;Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;)Z</span><br></pre></td></tr></table></figure>
<p>刚才看到的例子都是“调用函数”这个操作而已，貌似没有取函数返回的结果的操作？</p>
<p>在Java代码中调用函数和返回函数结果是一条语句完成的，而在smali里则需要分开来完成，在使用上述指令后，如果调用的函数返回非void，那么还需要用到move-result（返回基本数据类型）和move-result-object（返回对象）指令：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span>/<span class="number">4</span> v2, <span class="number">0x0</span></span><br><span class="line">invoke-virtual &#123;p0, v2&#125;, Lcom/disney/WMW/WMWActivity;-&gt;getPreferences(I)Landroid/content/SharedPreferences;</span><br><span class="line">move-result-object v1</span><br></pre></td></tr></table></figure>
<p> v1保存的就是调用getPreferences(int)方法返回的SharedPreferences实例。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">invoke-virtual &#123;v2&#125;, Ljava/lang/String;-&gt;length()I</span><br><span class="line">move-result v2</span><br></pre></td></tr></table></figure>
<p>v2保存的则是调用String.length()返回的整型。</p>
<h4 id="smali中函数实体分析"><a href="#smali中函数实体分析" class="headerlink" title="smali中函数实体分析"></a>smali中函数实体分析</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.<span class="function">method <span class="keyword">protected</span> <span class="title">onDestroy</span><span class="params">()</span>V</span></span><br><span class="line"><span class="function">    .locals 0</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">    .prologue</span></span><br><span class="line"><span class="function">    .line 277</span></span><br><span class="line"><span class="function">    invoke-<span class="keyword">super</span> </span>&#123;p0&#125;, Lcom/disney/common/BaseActivity;-&gt;onDestroy()V</span><br><span class="line"> </span><br><span class="line">    .line <span class="number">279</span></span><br><span class="line">    <span class="keyword">return</span>-<span class="keyword">void</span></span><br><span class="line">.end method</span><br></pre></td></tr></table></figure>
<p>这是onDestroy()函数，它的作用大家都知道。首先看到函数内第一句：.local 0，这句话很重要，标明了你在这个函数中最少要用到的本地寄存器的个数。在这里，由于只需要调用一个父类的onDestroy()处理，所以只需要用到p0，所以使用到的本地寄存器数为0。如果不清楚这个规则，很容易在植入代码后忘记修改.local 的值，那么回编译后运行时将会得到一个VerifyError错误，而且极难发现问题所在。我正是被这个问题困扰了很多次，最后研究发现.local的值有这个规律，于是在文档查证了一下果然是这个问题。例如我往onDestroy()增加一句：this.existed = true;那么应该改为（注意修改.local的值为1——使用到了v0这一个本地寄存器）：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.<span class="function">method <span class="keyword">protected</span> <span class="title">onDestroy</span><span class="params">()</span>V</span></span><br><span class="line"><span class="function">    .locals 1</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">    .prologue</span></span><br><span class="line"><span class="function">    .line 277</span></span><br><span class="line"><span class="function">    <span class="keyword">const</span>/4 v0, 0x1</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">    iput-<span class="keyword">boolean</span> v0, p0, Lcom/disney/WMW/WMWActivity</span>;-&gt;exited:Z</span><br><span class="line"> </span><br><span class="line">    invoke-<span class="keyword">super</span> &#123;p0&#125;, Lcom/disney/common/BaseActivity;-&gt;onDestroy()V</span><br><span class="line"> </span><br><span class="line">    .line <span class="number">279</span></span><br><span class="line">    <span class="keyword">return</span>-<span class="keyword">void</span></span><br><span class="line">.end method</span><br></pre></td></tr></table></figure>
<p>另外注意到.line这个标识，它是标注了该代码在原Java文件中的行数，Dalvik VM运行到.line XX时就将这个值存起来，如果在这一行运行时出错了，就往catLog输出这个值，这样我们就能看到具体是哪一行的问题了。</p>
<h3 id="smali插桩"><a href="#smali插桩" class="headerlink" title="smali插桩"></a>smali插桩</h3><p>何为插桩，引用一下wiki的解释：程序插桩，最早是由J.C. Huang 教授提出的，它是在保证被测程序原有逻辑完整性的基础上在程序中插入一些探针（又称为“探测仪”），通过探针的执行并抛出程序运行的特征数据，通过对这些数据的分析，可以获得程序的控制流和数据流信息，进而得到逻辑覆盖等动态信息，从而实现测试目的的方法。</p>
<p>插桩思路是，比如有些应用为防止被修改，会在开启的时候检查签名，签名结果为false的时候就会退出应用。所以就要定位检查的函数，然后通过log把目标值打印出来。</p>
<ol>
<li><p>写一个打印log的静态类</p>
</li>
<li><p>将其转换成smali文件</p>
</li>
<li><p>把文件放入工程里</p>
</li>
<li><p>在要打印log的地方添加如下代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">invoke-<span class="keyword">static</span> &#123;v1&#125;, Lcom/softard/MyLog;-&gt;Log(Ljava/lang/Object;)V</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新打包APK，运行，就可以看到打印结果</p>
</li>
</ol>
<p>补充一份实例：</p>
<p>先写一个Log类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.softard.xxxx;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"WOW"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"Code running in here."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后Android Studio将java代码转换成<code>smali</code></p>
<figure class="highlight smali"><table><tr><td class="code"><pre><span class="line"><span class="keyword">.class</span><span class="keyword"> public</span> <span class="class">Lcom/softard/xxxx/LogUtil;</span></span><br><span class="line"><span class="keyword">.super</span> <span class="class">Ljava/lang/Object;</span></span><br><span class="line"><span class="keyword">.source</span> <span class="string">"LogUtil.java"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># static fields</span></span><br><span class="line"><span class="keyword">.field</span><span class="keyword"> public</span><span class="keyword"> static</span><span class="keyword"> final</span> TAG:<span class="class">Ljava/lang/String;</span> = <span class="string">"WOW"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># direct methods</span></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span><span class="keyword"> constructor</span> &lt;init&gt;()V</span><br><span class="line"><span class="keyword">    .registers</span> 1</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .prologue</span></span><br><span class="line"><span class="keyword">    .line</span> 10</span><br><span class="line">   <span class="built_in"> invoke-direct </span>&#123;p0&#125;, <span class="class">Ljava/lang/Object;</span>-&gt;&lt;init&gt;()V</span><br><span class="line"></span><br><span class="line">    return-void</span><br><span class="line"><span class="keyword">.end method</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span><span class="keyword"> static</span> print()V</span><br><span class="line"><span class="keyword">    .registers</span> 2</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .prologue</span></span><br><span class="line"><span class="keyword">    .line</span> 14</span><br><span class="line">   <span class="built_in"> const-string </span>v0, <span class="string">"WOW"</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in"> const-string </span>v1, <span class="string">"Code running in here."</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-static </span>&#123;v0, v1&#125;, <span class="class">Landroid/util/Log;</span>-&gt;d(<span class="class">Ljava/lang/String;</span><span class="class">Ljava/lang/String;</span>)I</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 15</span><br><span class="line">    return-void</span><br><span class="line"><span class="keyword">.end method</span></span><br></pre></td></tr></table></figure>
<p>然后把<code>LogUtil.smali</code>文件放到反编译后的<code>smali</code>文件夹下的根目录。放根目录是为了绕过包名的影响，方便调用，所以<code>LogUtil.smali</code>文件的包名要去掉：</p>
<figure class="highlight smali"><table><tr><td class="code"><pre><span class="line"><span class="keyword">.class</span><span class="keyword"> public</span> <span class="class">Lcom/softard/xxxx/LogUtil;</span> -&gt; .class<span class="keyword"> public</span> <span class="class">LLogUtil;</span></span><br></pre></td></tr></table></figure>
<p>然后在目标位置调用打印方法：</p>
<figure class="highlight smali"><table><tr><td class="code"><pre><span class="line">invoke-virtual &#123;p1, v0&#125;, <span class="class">Landroid/view/View;</span>-&gt;setOnClickListener(<span class="class">Landroid/view/View$OnClickListener;</span>)V</span><br><span class="line"></span><br><span class="line">invoke-static &#123;&#125;, <span class="class">LLogUtil;</span>-&gt;print()V  &lt;-在此调用</span><br><span class="line"></span><br><span class="line"><span class="keyword">.line</span> 51</span><br><span class="line">invoke-static &#123;p0&#125;, <span class="class">Lcom/softard/rxdemo/demo/Chapter9;</span>-&gt;practice1(<span class="class">Landroid/content/Context;</span>)V</span><br></pre></td></tr></table></figure>
<blockquote>
<p>加代码的时候要注意，要找对地方加，就是在上个方法调用完后添加，比如<code>invoke-virtual</code> <code>invoke-static</code>等。而且这些指令后面不能有<code>move-result-object</code>，因为这个指令是获取方法的返回值，所以一般这么加代码：</p>
<ul>
<li>在invoke-static/invoke-virtual 指令返回类型是<code>V</code>之后可以加入</li>
<li>在invoke-static/invoke-virtual 指令返回类型不是<code>V</code>，那么在<code>move-result-object</code>命令之后可以加入</li>
</ul>
</blockquote>
<p>然后打包签名安装运行，可以看到我们要的log</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; adb logcat -s WOW</span><br><span class="line">16:12:55.443 26400 26400 D WOW     : Code running in here.</span><br></pre></td></tr></table></figure>
<h3 id="smali修改"><a href="#smali修改" class="headerlink" title="smali修改"></a>smali修改</h3><p>一般不会大量修改代码，而是会改一些关键逻辑。比如if，有时候修改一个判断就可以达到逻辑跳转的目的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>-eq vA, VB, cond_** 如果vA等于vB则跳转到cond_**。相当于<span class="keyword">if</span> (vA==vB)</span><br><span class="line"><span class="keyword">if</span>-ne vA, VB, cond_** 如果vA不等于vB则跳转到cond_**。相当于<span class="keyword">if</span> (vA!=vB)</span><br><span class="line"><span class="keyword">if</span>-lt vA, VB, cond_** 如果vA小于vB则跳转到cond_**。相当于<span class="keyword">if</span> (vA&lt;vB)</span><br><span class="line"><span class="keyword">if</span>-le vA, VB, cond_** 如果vA小于等于vB则跳转到cond_**。相当于<span class="keyword">if</span> (vA&lt;=vB)</span><br><span class="line"><span class="keyword">if</span>-gt vA, VB, cond_** 如果vA大于vB则跳转到cond_**。相当于<span class="keyword">if</span> (vA&gt;vB)</span><br><span class="line"><span class="keyword">if</span>-ge vA, VB, cond_** 如果vA大于等于vB则跳转到cond_**。相当于<span class="keyword">if</span> (vA&gt;=vB)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>-eqz vA, :cond_** 如果vA等于<span class="number">0</span>则跳转到:cond_** 相当于<span class="keyword">if</span> (VA==<span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span>-nez vA, :cond_** 如果vA不等于<span class="number">0</span>则跳转到:cond_**相当于<span class="keyword">if</span> (VA!=<span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span>-ltz vA, :cond_** 如果vA小于<span class="number">0</span>则跳转到:cond_**相当于<span class="keyword">if</span> (VA&lt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span>-lez vA, :cond_** 如果vA小于等于<span class="number">0</span>则跳转到:cond_**相当于<span class="keyword">if</span> (VA&lt;=<span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span>-gtz vA, :cond_** 如果vA大于<span class="number">0</span>则跳转到:cond_**相当于<span class="keyword">if</span> (VA&gt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span>-gez vA, :cond_** 如果vA大于等于<span class="number">0</span>则跳转到:cond_**相当于<span class="keyword">if</span> (VA&gt;=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>不建议在程序原有的方法上增加大量逻辑，这样可能会出现很多寄存器方面的错误导致编译失败。比较好的方法是：把想要增加的逻辑先用java写成一个apk，然后把这个apk反编译成smali文件，随后把反编译后的这部分逻辑的smali文件插入到目标程序的smali文件夹中，然后再在原来的方法上采用invoke的方式调用新加入的逻辑。这样的话不管加入再多的逻辑，也只是修改了原程序的几行代码而已。</p>
<h2 id="汇编ARM指令"><a href="#汇编ARM指令" class="headerlink" title="汇编ARM指令"></a>汇编ARM指令</h2><h3 id="ARM指令中寻址方式"><a href="#ARM指令中寻址方式" class="headerlink" title="ARM指令中寻址方式"></a>ARM指令中寻址方式</h3><ul>
<li><p>立即数寻址</p>
<p>也叫立即寻址，是一种特殊寻址方式。操作数本身包含在指令中，只要取出指令也就取到了操作数，该操作数叫立即数，对应寻址方式叫做立即寻址。</p>
<p>MOV R0, #64; R0←64</p>
</li>
<li><p>寄存器寻址</p>
<p>利用寄存器中的数值作为操作数，也称为寄存器直接寻址。</p>
<p>ADD R0, R1, R2; R0←R1+R2</p>
</li>
<li><p>寄存器间接寻址</p>
<p>把寄存器中的值作为地址，通过这个地址去取得操作数，操作数本身存放在存储器中。</p>
<p>LDR R0,[R1]; R0←[R1]</p>
</li>
<li><p>寄存器偏移寻址</p>
<p>这是ARM指令集特有的寻址方式，它是在寄存器寻址得到操作数后再进行位移操作，得到最终操作数。</p>
<p>MOV R0,R2,LSL #3;  R0←R2*8, R2的值左移3位，结果赋值给R0</p>
</li>
<li><p>寄存器基址变址寻址</p>
<p>是在寄存器间接寻址的基础上扩展来的。它将寄存器中的值与指令中给出的地址偏移量相加，从而得到一个地址，通过这个地址取得操作数。</p>
<p>LDR R0,[R1, #4];  R0←[R1+4] 将R1的内容加上4形成操作数地址，取得的操作数存入寄存器R0中</p>
</li>
<li><p>多寄存器寻址</p>
<p>可以一次完成多个寄存器值的传送</p>
<p>LDMIA R0,{R1,R2,R3,R4};   R1←[R0], R2←[R0+4], R3←[R0+8], R4←[R0+12]</p>
</li>
<li><p>堆栈寻址</p>
<p>堆栈按先进后出工作，使用堆栈指针SP指示当前的操作位置，堆栈指针总是指向栈顶</p>
<p>STMFD SP!, {R1 - R7, LR}    将R1-R7 LR压入堆栈。满递减堆栈</p>
<p>LDMED SP!,{R1 - R7, LR}    将堆栈中的数据取回到R1-R7，LR寄存器。空递减堆栈</p>
</li>
</ul>
<h3 id="ARM中寄存器"><a href="#ARM中寄存器" class="headerlink" title="ARM中寄存器"></a>ARM中寄存器</h3><p><strong>R0-R3</strong></p>
<p>用于函数参数及返回值的传递</p>
<p><strong>R4-R6,R8,R10-R11</strong></p>
<p>没有特殊规定，就是普通的通用寄存器</p>
<p><strong>R7</strong></p>
<p>栈帧指针（Frame Pointer）指向前一个保存的栈帧和链接寄存器（link register lr）在栈上的地址</p>
<p><strong>R9</strong></p>
<p>操作系统保留</p>
<p><strong>R12</strong></p>
<p>IP intra-procedure scratch</p>
<p><strong>R13</strong></p>
<p>SP stack pointer 栈顶指针</p>
<p><strong>R14</strong></p>
<p>link register 存放函数的返回地址</p>
<p><strong>R15</strong></p>
<p>pogram counter 指向当前指令地址</p>
<h3 id="ARM常用指令"><a href="#ARM常用指令" class="headerlink" title="ARM常用指令"></a>ARM常用指令</h3><p><strong>ADD</strong>    加指令</p>
<p><strong>SUB</strong>    减指令</p>
<p><strong>STR</strong>     把寄存器内容存到栈上</p>
<p><strong>LDR</strong>    把栈上内容载入一个寄存器中</p>
<p><strong>.W</strong>        是一个可选指令宽度说明符。不会影响为此指令的行为，它只是确保生成32位指令。</p>
<p><strong>BL</strong>        执行函数调用，并把使lr指向调用者的下一条指令，即函数的返回地址</p>
<p><strong>BLX</strong>        同上，但是在ARM和thumb指令集间切换</p>
<p><strong>CMP</strong>    指令进行比较两个操作数的大小</p>
<p>未完成</p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="https://github.com/wossoneri/wossoneri.github.io/blob/master/pay/wechatpay.JPG?raw=true" alt="Wossoneri 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="https://github.com/wossoneri/wossoneri.github.io/blob/master/pay/alipay.JPG?raw=true" alt="Wossoneri 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Wossoneri
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://wossoneri.github.io/2019/09/12/[Android][Security]Decompile-smali/" title="[Android][Security] Android 逆向之 smali">http://wossoneri.github.io/2019/09/12/[Android][Security]Decompile-smali/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"><i class="fa fa-tag"></i> Android</a>
          
            <a href="/tags/smali/" rel="tag"><i class="fa fa-tag"></i> smali</a>
          
            <a href="/tags/逆向/" rel="tag"><i class="fa fa-tag"></i> 逆向</a>
          
            <a href="/tags/安全/" rel="tag"><i class="fa fa-tag"></i> 安全</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/05/10/[Android]why-Looper-loop-will-not-block-main-thread/" rel="next" title="[Android] 为什么主线程不会因为Looper.loop()方法造成阻塞">
                <i class="fa fa-chevron-left"></i> [Android] 为什么主线程不会因为Looper.loop()方法造成阻塞
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/10/12/[Android][Security]Decompile-xposed/" rel="prev" title="[Android][Security] Android 逆向之 xposed">
                [Android][Security] Android 逆向之 xposed <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://avatars2.githubusercontent.com/u/11764431?v=3&s=460" alt="Wossoneri">
            
              <p class="site-author-name" itemprop="name">Wossoneri</p>
              <p class="site-description motion-element" itemprop="description">就怕你一生碌碌无为，还安慰自己平凡可贵</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">116</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">120</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/wossoneri" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-globe"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://weibo.com/u/1171637315/home?topnav=1&wvr=5" target="_blank" title="Weibo">
                    
                      <i class="fa fa-fw fa-globe"></i>Weibo</a>
                </span>
              
            
          </div>

          
          
            <div class="cc-license motion-element" itemprop="license">
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
                <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons">
              </a>
            </div>
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-globe"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.cnblogs.com/rossoneri/" title="我的博客园博客" target="_blank">我的博客园博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://zhangqinglian.github.io/" title="清廉的Android博客" target="_blank">清廉的Android博客</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#几个概念"><span class="nav-number">1.</span> <span class="nav-text">几个概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#APK"><span class="nav-number">1.1.</span> <span class="nav-text">APK</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dalvik字节码"><span class="nav-number">1.2.</span> <span class="nav-text">Dalvik字节码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何逆向"><span class="nav-number">2.</span> <span class="nav-text">如何逆向</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查看资源文件"><span class="nav-number">2.1.</span> <span class="nav-text">查看资源文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看源码"><span class="nav-number">2.2.</span> <span class="nav-text">查看源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分析思路"><span class="nav-number">2.3.</span> <span class="nav-text">分析思路</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Smali"><span class="nav-number">3.</span> <span class="nav-text">Smali</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#指令"><span class="nav-number">3.1.</span> <span class="nav-text">指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据类型"><span class="nav-number">3.2.</span> <span class="nav-text">数据类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#函数"><span class="nav-number">3.3.</span> <span class="nav-text">函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件分析"><span class="nav-number">3.4.</span> <span class="nav-text">文件分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#smali寄存器"><span class="nav-number">3.4.1.</span> <span class="nav-text">smali寄存器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#smali中的继承、接口、包信息"><span class="nav-number">3.4.2.</span> <span class="nav-text">smali中的继承、接口、包信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#smali中的成员变量"><span class="nav-number">3.4.3.</span> <span class="nav-text">smali中的成员变量</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#获取static-fields的指令类似是："><span class="nav-number">3.4.3.1.</span> <span class="nav-text">获取static fields的指令类似是：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#获取instance-fields"><span class="nav-number">3.4.3.2.</span> <span class="nav-text">获取instance fields</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#获取array的还有aget和aget-object"><span class="nav-number">3.4.3.3.</span> <span class="nav-text">获取array的还有aget和aget-object</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#put指令的使用和get指令是统一的"><span class="nav-number">3.4.3.4.</span> <span class="nav-text">put指令的使用和get指令是统一的</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#smali中的函数调用"><span class="nav-number">3.4.4.</span> <span class="nav-text">smali中的函数调用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#smali中函数实体分析"><span class="nav-number">3.4.5.</span> <span class="nav-text">smali中函数实体分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#smali插桩"><span class="nav-number">3.5.</span> <span class="nav-text">smali插桩</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#smali修改"><span class="nav-number">3.6.</span> <span class="nav-text">smali修改</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#汇编ARM指令"><span class="nav-number">4.</span> <span class="nav-text">汇编ARM指令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ARM指令中寻址方式"><span class="nav-number">4.1.</span> <span class="nav-text">ARM指令中寻址方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ARM中寄存器"><span class="nav-number">4.2.</span> <span class="nav-text">ARM中寄存器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ARM常用指令"><span class="nav-number">4.3.</span> <span class="nav-text">ARM常用指令</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wossoneri</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  







<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    

    
      <script type="text/javascript">
      function renderGitment(){
        var gitment = new Gitmint({
            id: '1568300400000', 
            owner: 'wossoneri',
            repo: 'wossoneri.github.io',
            
            lang: "" || navigator.language || navigator.systemLanguage || navigator.userLanguage,
            
            oauth: {
            
            
                client_secret: '9d7241035e9211e280e753883f5b8f5a1a49bf77',
            
                client_id: '40b6c719a11e3fca29e8'
            }});
        gitment.render('gitment-container');
      }

      
      renderGitment();
      
      </script>
    







  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
